<!DOCTYPE html>

{% extends "base_generic.html" %}

{% block content %}
<html lang="en">
<head>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
	<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
	<script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>  <!-- Include Socket.io library -->



    <title>Stimmungskarte Krems | MUSTER</title>
</head>
<body>

<!-- POPUP -->



   <!-- Counter container -->

<div class="main-container" style="display: {% if current_user.is_authenticated %}block{% else %}none{% endif %};">
<!-- Add this button where you want it to appear on your HTML page -->


<div style="display: flex; height: 100vh">
    <div id="map" style="flex-basis: 70%; border-radius: 0px">
	
	
	<!-- COUNTER / VIS DIV -->
	<div class="parent-container">
<div id="counter-container" class="countercontainer"></div>
</div>
<div id="togglebutton-container" class="togglebuttoncontainer">
<button class="toggle-button" data-pin-type="ff5c00" data-toggled="true">
    <img src="static/visicon_ff5c00.png" alt="Visibility Icon" class="icon untoggled-icon">
    <img src="static/visicon_ff5c00_2.png" alt="Visibility Icon" class="icon toggled-icon" style="display:none;">
</button>
<button class="toggle-button" data-pin-type="9A031E" data-toggled="true">
    <img src="static/visicon_9A031E.png" alt="Visibility Icon" class="icon untoggled-icon">
    <img src="static/visicon_9A031E_2.png" alt="Visibility Icon" class="icon toggled-icon" style="display:none;">
</button>
<button class="toggle-button" data-pin-type="133873" data-toggled="true">
    <img src="static/visicon_133873.png" alt="Visibility Icon" class="icon untoggled-icon">
    <img src="static/visicon_133873_2.png" alt="Visibility Icon" class="icon toggled-icon" style="display:none;">
</button>
<button class="toggle-button" data-pin-type="358400" data-toggled="true">
    <img src="static/visicon_358400.png" alt="Visibility Icon" class="icon untoggled-icon">
    <img src="static/visicon_358400_2.png" alt="Visibility Icon" class="icon toggled-icon" style="display:none;">
</button>
<button class="toggle-button" data-pin-type="431307" data-toggled="true">
    <img src="static/visicon_431307.png" alt="Visibility Icon" class="icon untoggled-icon">
    <img src="static/visicon_431307_2.png" alt="Visibility Icon" class="icon toggled-icon" style="display:none;">
</button>
<button class="toggle-button" data-pin-type="070707" data-toggled="true">
    <img src="static/visicon_070707.png" alt="Visibility Icon" class="icon untoggled-icon">
    <img src="static/visicon_070707_2.png" alt="Visibility Icon" class="icon toggled-icon" style="display:none;">
</button>

</div>
</div>
    <div id="sidebar" style="flex-basis: 30%; padding: 10px; background-color: #ffffff; margin-bottom: 0px;">


<div style="display: flex; align-items: center;">

<div id="infoModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0, 0, 0, 0.7); align-items:center; justify-content:center; z-index:100000;">
    <div class="info-field" id="conditionsField">
            <div class="info-subtitle" style="margin-bottom: 30px">Erklärung aller Funktionen</div> 
            <div class="info-text" ></div>
			            <div class="info-text" style="margin-bottom: 30px">Sie können Hinweise an Orten anbringen, die Sie entweder angenehm oder problematisch finden.</div>  

                 <div class="info-subtitle"><span style="color: #f77f00; font-weight: bold;">Alle Pins löschen:</span></div>
            <div class="info-text"><span style="color: #f77f00; font-weight: bold;"></span>Entfernt alle Pins von der Karte. Nicht umkehrbar.</div> 
			
						      <div class="info-subtitle"><span style="color: #f77f00; font-weight: bold;">Einen einzelnen Pin löschen:</span></div>
            <div class="info-text"><span style="color: #f77f00; font-weight: bold;"></span>Wählen Sie einen Pin auf der Karte aus und klicken Sie auf „Löschen“.</div> 
            
			<div class="info-subtitle"><span style="color: #f77f00; font-weight: bold;">GeoJSON herunterladen (pins):</span></div>
            <div class="info-text"><span style="color: #f77f00; font-weight: bold;"></span>Laden Sie eine GeoJSON-Datei herunter, in der alle Pins gespeichert sind, einschließlich ID, Typ, Koordinaten und Beschreibung.</div>
			
                 <div class="info-subtitle"><span style="color: #f77f00; font-weight: bold;">Laden Sie ein GeoJSON hoch:</span></div>
            <div class="info-text"><span style="color: #f77f00; font-weight: bold;"></span>Laden Sie eine zuvor heruntergeladene GeoJSON-Datei hoch. Alle Pins werden genau dort platziert, wo sie waren.</div> 
			

			        </div>
</div>
</div>


<img src="static/logo_long.png" style="max-width: 100%; height: auto; border: 5px solid white; display: block; margin-top: -5px;     border-radius: 0px;">
    <h2>Hier ist das Admin-Menü.</h2>
<h2 style="margin-bottom: -15px;">Sie haben Zugriff auf mehrere Verwaltungsoptionen.</h2>
<h4 style="text-align: center;">Weitere Optionen oder Funktionen können auf Anfrage erstellt werden.</h4>

		<button id="aboutBtn" class="button-menu" style="background-color: #031927; margin-top: 10px">Wie funktioniert's?</button>



<h2>Alle Pins löschen / herunterladen:</h2>

<div style="display: flex; justify-content: flex-start; align-items: center; gap: 10px;">
    <button id="deleteAllPins" class="delete-button" style="margin-top: 10px">Alle Pins löschen</button>
    <form action="/export_geojson" method="get" style="margin-top: 10px;">
        <button type="submit" class="delete-button">GeoJSON herunterladen (Pins)</button>
    </form>
</div>
<h2 style="margin-top: 10px;">Laden Sie eine GeoJSON Datei hoch:</h2>
<form action="/upload_geojson" method="post" enctype="multipart/form-data">
    <label for="geojson_file" style="margin-top: 10px"></label>
    <input type="file" style="margin-top: 10px" name="geojson_file" accept=".json,application/json">
    <button type="submit">Hochladen</button>
</form>


<!-- Mappy Container -->
<div id="mappy-container">
    <div id="mapMobile">
	<!-- COUNTER / VIS DIV -->

</div>
	
</div>


        <!-- Pin Menu -->
         
<div class="centered-text-container" style="margin-bottom: 0px;">
	</div>
	<div class="current-desktop">
<div id="current-selection" class="current">Ausgewählt: <span id="selected-pin-type">...</span></div>
</div>
	
	<div class="dropdown-container">


    <div id="dropdown-options" class="options">
        <div class="pin-menu" data-color="ff5c00" style="background-color: #ff5c00;">
            <h3>Dieser Ort gefällt mir.</h3>
        </div>
        <div class="pin-menu" data-color="9A031E" style="background-color: #9A031E;">
            <h3>Hier fühle ich mich unsicher.</h3>
        </div>
        <div class="pin-menu" data-color="133873" style="background-color: #133873;">
            <h3>Hier gibt es Probleme mit dem Parken.</h3>
        </div>
        <div class="pin-menu" data-color="358400" style="background-color: #358400;">
            <h3>Hier verbringe ich gerne meine Freizeit.</h3>
        </div>
        <div class="pin-menu" data-color="431307" style="background-color: #431307;">
            <h3>Dieser Ort braucht eine Verbesserung.</h3>
        </div>
        <div class="pin-menu" data-color="070707" style="background-color: #070707;">
            <h3>An diesem Ort fehlt ein Service.</h3>
        </div>
    </div>
</div>

	<div id="pin-menu-desktop">

<div class="pin-menu" data-color="ff5c00" style="background-color: #ff5c00;">
    <h3>Dieser Ort gefällt mir.</h3>
</div>
<div class="pin-menu" data-color="9A031E" style="background-color: #9A031E;">
    <h3>Hier fühle ich mich unsicher.</h3>
</div>
<div class="pin-menu" data-color="133873" style="background-color: #133873;">
    <h3>Hier gibt es Probleme mit dem Parken.</h3>
</div>
<div class="pin-menu" data-color="358400" style="background-color: #358400;">
    <h3>Hier verbringe ich gerne meine Freizeit.</h3>
</div>
<div class="pin-menu" data-color="431307" style="background-color: #431307;">
    <h3>Dieser Ort braucht eine Verbesserung.</h3>
</div>
<div class="pin-menu" data-color="070707" style="background-color: #070707;">

    <h3>An diesem Ort fehlt ein Service.</h3>
	</div>
		</div>






	</div>
	</div>
	
	</div>
</body>

<!-- LOGIC -->




  <script>

    </script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>

// Initialize main map
    const map = L.map('map').setView([48.4102, 15.6022], 10);
    map.setMinZoom(15);

    // Initialize mobile map
    const mapMobile = L.map('mapMobile').setView([48.4102, 15.6022], 10);
    mapMobile.setMinZoom(14);

    setTimeout(() => {
        mapMobile.invalidateSize(true);
        map.invalidateSize(true);
    }, 1000);

    map.doubleClickZoom.disable();

    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const osmLayerMobile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(mapMobile);

    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });
	
	

    L.control.layers({
        "Standardkarte": osmLayer,
        "Satellit": satelliteLayer
    }).addTo(map);

    L.control.layers({
        "Standardkarte": osmLayerMobile,
        "Satellit": satelliteLayer
    }).addTo(mapMobile);
	
	

    map.on('baselayerchange', function(eventLayer) {
        if (eventLayer.name === 'Satellit') {
            setSatelliteStyle(map);
        } else {
            resetStyle(map);
        }
    });

    mapMobile.on('baselayerchange', function(eventLayer) {
        if (eventLayer.name === 'Satellit') {
            setSatelliteStyle(mapMobile);
        } else {
            resetStyle(mapMobile);
        }
    });
	
	
	const layers = {
    "ff5c00": L.layerGroup().addTo(map).addTo(mapMobile),
    "9A031E": L.layerGroup().addTo(map).addTo(mapMobile),
    "133873": L.layerGroup().addTo(map).addTo(mapMobile),
    "358400": L.layerGroup().addTo(map).addTo(mapMobile),
    "431307": L.layerGroup().addTo(map).addTo(mapMobile),
    "070707": L.layerGroup().addTo(map).addTo(mapMobile)
};

// Function to add marker to both map and mapMobile
function addMarkerToMaps(latlng, pinType, description) {
    const marker = L.marker(latlng, {
        icon: L.divIcon({
            className: `pin-${pinType}`,
            iconSize: [24, 24]
        })
    }).bindPopup(description);
    
    marker.addTo(layers[pinType]);
}

function loadPins(pins) {
    pins.forEach(pin => addMarkerToMaps([pin.lat, pin.lon], pin.pin_type, pin.description));
}
// Event listeners for checkboxes
document.querySelectorAll(".filter-checkbox").forEach(checkbox => {
    checkbox.addEventListener("change", function() {
        const pinType = this.getAttribute("data-pin-type");
        if (this.checked) {
            map.addLayer(layers[pinType]);
            mapMobile.addLayer(layers[pinType]);
        } else {
            map.removeLayer(layers[pinType]);
            mapMobile.removeLayer(layers[pinType]);
        }
    });
});

// New code to establish WebSocket connection
const socket = io.connect(location.origin);

// New event listener for 'update_counters' WebSocket message
socket.on('update_counters', function() {
    fetchAndDisplayCounters();
});



    function setSatelliteStyle(mapInstance) {
        const mapContainer = mapInstance.getContainer();
        mapContainer.classList.add("satellite-view");
    }

    function resetStyle(mapInstance) {
        const mapContainer = mapInstance.getContainer();
        mapContainer.classList.remove("satellite-view");
    }

    map.on('click', handleMapClick);
    mapMobile.on('click', handleMapClick);

 

const latlng = [48.4102, 15.6022];
const distanceInKm = Math.sqrt(10);
const point = turf.point([latlng[1], latlng[0]]);
const buffered = turf.buffer(point, distanceInKm / 2, { units: 'kilometers' });
let bbox = turf.bbox(buffered);

// Expanding the bounds to the west and east by about 5km
const expandDistance = 3 / 111.32;  // 5km in degrees (approximate, assuming 1 degree = 111.32km)
bbox[0] -= expandDistance;  // west
bbox[2] += expandDistance;  // east

// Create square coordinates from the updated bbox
let squareCoords = [
    [bbox[0], bbox[1]],  // bottom-left
    [bbox[0], bbox[3]],  // top-left
    [bbox[2], bbox[3]],  // top-right
    [bbox[2], bbox[1]],  // bottom-right
    [bbox[0], bbox[1]]   // back to bottom-left to close the polygon
];

function keepInView(mapInstance, boundaryPolygon) {
    mapInstance.on('moveend', function() {
        const expandedBounds = boundaryPolygon.getBounds().pad(1);  // Expands bounds by 100%
        if (!expandedBounds.contains(mapInstance.getBounds())) {
            mapInstance.fitBounds(boundaryPolygon.getBounds());
        }
    });
}
// ... rest of your code ...









// Create the boundary polygons
// Create the boundary polygons
const squareForMap = L.polygon([
    [squareCoords[0][1], squareCoords[0][0]],
    [squareCoords[1][1], squareCoords[1][0]],
    [squareCoords[2][1], squareCoords[2][0]],
    [squareCoords[3][1], squareCoords[3][0]],
    [squareCoords[4][1], squareCoords[4][0]]
], {color: 'grey', weight: 1, fillColor: 'none'}).addTo(map);

const squareForMapMobile = L.polygon([
    [squareCoords[0][1], squareCoords[0][0]],
    [squareCoords[1][1], squareCoords[1][0]],
    [squareCoords[2][1], squareCoords[2][0]],
    [squareCoords[3][1], squareCoords[3][0]],
    [squareCoords[4][1], squareCoords[4][0]]
], {color: 'grey', weight: 1, fillColor: 'none'}).addTo(mapMobile);

// Apply the keepInView function to both map instances
keepInView(map, squareForMap);
keepInView(mapMobile, squareForMapMobile);




// Add a light grey overlay for the main map
const outerBounds = [
  [-90, -180],
  [-90, 180],
  [90, 180],
  [90, -180]
];

const overlay = L.polygon([outerBounds, [
    [squareCoords[0][1], squareCoords[0][0]],
    [squareCoords[1][1], squareCoords[1][0]],
    [squareCoords[2][1], squareCoords[2][0]],
    [squareCoords[3][1], squareCoords[3][0]],
    [squareCoords[4][1], squareCoords[4][0]]
]], {
    color: 'none',
    fillColor: 'grey',
    fillOpacity: 0.0  // Reduced opacity to 0.1
}).addTo(map);

const overlayMobile = L.polygon([outerBounds, [
    [squareCoords[0][1], squareCoords[0][0]],
    [squareCoords[1][1], squareCoords[1][0]],
    [squareCoords[2][1], squareCoords[2][0]],
    [squareCoords[3][1], squareCoords[3][0]],
    [squareCoords[4][1], squareCoords[4][0]]
]], {
    color: 'none',
    fillColor: 'grey',
    fillOpacity: 0.0  // Reduced opacity to 0.1
}).addTo(mapMobile);




    function calculateBounds(lat, lng, distanceInKm) {
    const R = 6371;  // Earth's radius in kilometers
    const dLat = distanceInKm / R;
    const dLng = distanceInKm / (R * Math.cos((Math.PI * lat) / 180));
    return [
        [lat - dLat, lng - dLng],
        [lat + dLat, lng + dLng]
    ];
}
	// Add this event listener to stop propagation of click events from counter-container
document.getElementById('counter-container').addEventListener('click', function(event) {
    event.stopPropagation();
});

	// Add this event listener to stop propagation of click events from counter-container
document.getElementById('togglebutton-container').addEventListener('click', function(event) {
    event.stopPropagation();
});



	// Add this line to declare currentPopupLatLng
	let currentPopupLatLng = null;
    
    function handleMapClick(e) {
    const targetSquare = e.target === map ? squareForMap : squareForMapMobile;
    
    if (selectedColor === null) {
        alert("Wählen Sie zunächst eine Option aus.");
        return;
    }

    if (targetSquare.getBounds().contains(e.latlng)) {
        // Add this check to see if a popup is already open at the clicked position
        if (currentPopupLatLng && currentPopupLatLng.equals(e.latlng)) {
            return;
        }
        currentPopupLatLng = e.latlng;
		
		

        const containerWidth = document.querySelector('#sidebar').offsetWidth;
        const fontSize = Math.max(12, containerWidth / 30);

        const popupContent = `
            <textarea id="feedbackText" rows="4" cols="40" placeholder="Was denken Sie über diesen Ort?" style="font-size: ${fontSize}px;"></textarea><br>
            <button id="postFeedback" style="font-size: ${fontSize}px;">Fertig</button>
            <button id="cancelFeedback" style="font-size: ${fontSize}px;">Löschen</button>
        `;

        const popup = L.popup()
            .setLatLng(e.latlng)
            .setContent(popupContent)
            .openOn(e.target);

           
    document.getElementById('postFeedback').addEventListener('click', function() {
        const feedback = document.getElementById('feedbackText').value;
        if (feedback.length >= 10 && feedback.length <= 150) {
                    L.marker(e.latlng, {
                        icon: L.divIcon({
                            className: `pin-style pin-${selectedColor}`,
                            iconSize: [24, 24]
                        })
                    }).bindPopup(feedback).addTo(e.target);
					
					
					


                   // Generate a random molen_id
        const molen_id = Math.random().toString(36).substring(2, 10);

        fetch('/add_pin', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        lat: e.latlng.lat,
        lon: e.latlng.lng,
        pin_type: selectedColor,
        description: feedback,
        molen_id: `M${Math.floor(Math.random() * 1e9)}`  // Generate a random molen_id client-side
    })
});


                    e.target.closePopup();
                } else {
            alert("Bitte geben Sie zwischen 10 und 150 Zeichen ein.");
                }
            });

            document.getElementById('cancelFeedback').addEventListener('click', function() {
                popup._close();
            });
        } else {
            alert("Sie dürfen Notizen nur innerhalb des Stadtgebiets platzieren.");
        }
    }

    function loadPins(pins) {
    pins.forEach(pin => {
        const marker = L.marker([pin.lat, pin.lon], {
            icon: L.divIcon({
                className: `pin-${pin.pin_type}`,
                iconSize: [24, 24]
            })
        }).bindPopup(`
            ${pin.description}
            <br>
            <button onclick="deletePin('${pin.molen_id}')">Delete</button>
        `).addTo(layers[pin.pin_type]);
    });
}

function removeStar(molen_id) {
    fetch(`/remove_highlight/${molen_id}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Assuming you have a reference to the map and the star icon marker
            const starMarker = starMarkers[molen_id];  // Assume starMarkers is an object holding references to star icon markers
            map.removeLayer(starMarker);  // Remove star icon from map
            delete starMarkers[molen_id];  // Remove reference to star icon marker
        } else {
            console.error('Failed to remove highlight:', data.error);
        }
    });
}


function deletePin(molen_id) {
    fetch(`/delete_pin_by_molen_id/${molen_id}`, {
        method: 'POST'
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the pin from the map
            // Assuming you have stored your markers in a global object called `markers`
            const marker = markers[molen_id];
            if (marker) {
                marker.remove();
                delete markers[molen_id];  // Remove the marker from the markers object
            }
        } else {
            alert('Error deleting pin');
        }
    });
}


    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const pins = {
        "ff5c00": "Something to be proud of",
        "9A031E": "Unsafe area",
        "133873": "Parking issues",
        "358400": "Nice to spend free time at",
        "431307": "Needs improvement",
        "070707": "Missing service"
    };
	
	 // Function to create checkboxes dynamically
    function createCheckboxes() {
        const filterMenu = document.getElementById('filter-menu');

        for (const [color, description] of Object.entries(pins)) {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');

            checkbox.type = 'checkbox';
            checkbox.className = 'filter-checkbox';
            checkbox.setAttribute('data-pin-type', color);
            checkbox.checked = true;

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${description}`));
            label.appendChild(document.createElement('br'));

            filterMenu.appendChild(label);
        }
    }

    // Create the checkboxes when the document is loaded
    document.addEventListener("DOMContentLoaded", function() {
        createCheckboxes();

        // Your existing code to fetch pins
        fetch('/')
            .then(response => response.json())
            .then(data => loadPins(data.pins));
    });


    let selectedColor = null;

    document.querySelectorAll(".pin-menu").forEach(menu => {
        menu.addEventListener("click", function() {
            selectedColor = this.getAttribute("data-color");
            document.getElementById("selected-pin-type").innerText = pins[selectedColor];
            document.getElementById("selected-pin-type").style.color = selectedColor;
        });
    });

    document.addEventListener("DOMContentLoaded", function() {
        fetch('/')
            .then(response => response.json())
            .then(data => loadPins(data.pins));
    });
	






// Global object to keep track of toggle states
const toggleStates = {
    "ff5c00": true,
    "9A031E": true,
    "133873": true,
    "358400": true,
    "431307": true,
    "070707": true
};

// Store the markers in an object so you can reference them later
const markers = {
    "ff5c00": [],
    "9A031E": [],
    "133873": [],
    "358400": [],
    "431307": [],
    "070707": []
};

// Updated loadPins function to handle opacity
function loadPins(pins) {
    pins.forEach(pin => {
        const marker = L.marker([pin.lat, pin.lon], {
            icon: L.divIcon({
                className: `pin-${pin.pin_type}`,
                iconSize: [24, 24]
            }),
            opacity: toggleStates[pin.pin_type] ? 1 : 0.05  // Set opacity based on toggle state
        }).bindPopup(pin.description);

        marker.addTo(layers[pin.pin_type]);
        markers[pin.pin_type].push(marker);  // Store the marker
    });
}

   // Updated script to handle toggle-button menu interactions
    document.querySelectorAll('.toggle-button').forEach(button => {
        button.addEventListener('click', () => {
            const pinType = button.getAttribute('data-pin-type');
            toggleStates[pinType] = !toggleStates[pinType];  // Toggle the state

            // Toggle the display styles of the img tags
            const untoggledIcon = button.querySelector('.untoggled-icon');
            const toggledIcon = button.querySelector('.toggled-icon');
            untoggledIcon.style.display = toggleStates[pinType] ? '' : 'none';
            toggledIcon.style.display = toggleStates[pinType] ? 'none' : '';

            // Update the opacity of existing markers of the same type
            document.querySelectorAll(`.pin-${pinType}`).forEach(markerElement => {
                markerElement.style.opacity = toggleStates[pinType] ? 1 : 0.05;
            });
        });
    });


</script>




<script>

<!-- LOGIC - DROPDOWN MOBILE -->

document.querySelector('#dropdown-button').addEventListener('click', function() {
    let options = document.querySelector('#dropdown-options');
    if (options.style.display === 'none' || !options.style.display) {
        options.style.display = 'block';
    } else {
        options.style.display = 'none';
    }
});

let pinMenus = document.querySelectorAll('.pin-menu');
pinMenus.forEach(function(menu) {
    menu.addEventListener('click', function() {
        let color = this.getAttribute('data-color');
        let text = this.querySelector('h3').textContent;
        document.querySelector('#dropdown-button').textContent = text;
        document.querySelector('#dropdown-button').style.backgroundColor = '#' + color;
        
        document.addEventListener('DOMContentLoaded', function () {
    const dropdownButton = document.getElementById('dropdown-button');
    const dropdownOptions = document.getElementById('dropdown-options');
    const pinMenus = document.querySelectorAll('.pin-menu');
    const allPins = document.querySelectorAll('.pin'); // Assuming all pins have a class of 'pin'

    // Toggle the visibility of the dropdown options when the button is clicked
    dropdownButton.addEventListener('click', function () {
        dropdownOptions.style.display = dropdownOptions.style.display === 'block' ? 'none' : 'block';
    });

    // Add a click event for each pin menu option
    pinMenus.forEach(function (menu) {
        menu.addEventListener('click', function (e) {
            const selectedText = e.target.closest('.pin-menu').querySelector('h3').textContent; // Get the text of the selected option

            dropdownButton.textContent = `Ausgewählt: ${selectedText}`; // Update the button text

            const selectedColor = e.currentTarget.getAttribute('data-color');
            showPins(selectedColor); // Activate the corresponding pins

            // Close the dropdown after selection
            dropdownOptions.style.display = 'none';
        });
    });

    function showPins(colorCode) {
        // Hide all pins by default
        allPins.forEach(pin => pin.style.display = 'none');

        // Show only the pins that match the selected color code
        const matchingPins = document.querySelectorAll(`.pin[data-color="${colorCode}"]`);
        matchingPins.forEach(pin => pin.style.display = 'block');
    }
});

    });
});

</script>






<script>

<!-- LOGIC - COLOR OF CURRENTLY CHOSEN TEXT -->
document.addEventListener("DOMContentLoaded", function() {
    // Get all pin-menu elements
    var pinMenus = document.querySelectorAll('.pin-menu');

    // Add click event to each pin-menu
    pinMenus.forEach(function(menu) {
        menu.addEventListener('click', function() {
            // Get the color from the clicked pin-menu
            var color = menu.getAttribute('data-color');

            // Update the color and text of the 'selected-pin-type' span
            var selectedPinType = document.getElementById('selected-pin-type');
            selectedPinType.style.color = "#" + color;
            selectedPinType.innerText = menu.querySelector('h3').innerText;
        });
    });
});

</script>
<script>
window.addEventListener("resize", function() {
    mapMobile.invalidateSize();
});

</script>
<!-- LOGIC - BUTTON RESIZING -->
<script>
function updateFontSize() {
    const containerWidth = document.querySelector('#sidebar').offsetWidth;
    const isMobile = window.innerWidth <= 900; // Check if the device is mobile

    const baseFontSize = isMobile ? 
                         Math.max(16, containerWidth / 20) :  
                         Math.max(12, containerWidth / 30);

    document.querySelectorAll('.pin-menu h3, #aboutBtn, #dropdown-button, #current-selection').forEach(el => {
        el.style.fontSize = `${baseFontSize}px`;
    });

    const regularH2FontSize = Math.min(30, baseFontSize);
    document.querySelectorAll('#sidebar h2:not(.centered-text-container h2)').forEach(h2 => {
        h2.style.fontSize = `${regularH2FontSize}px`;
    });

    const centeredH2FontSize = Math.max(15, containerWidth / 25);
    document.querySelectorAll('.centered-text-container h2').forEach(h2 => {
        h2.style.fontSize = `${centeredH2FontSize}px`;
    });

    // Adjust the pin-menu font size on mobile
    if (isMobile) {
        document.querySelectorAll('.pin-menu h3').forEach(el => {
            el.style.fontSize = `${Math.max(12, baseFontSize * 0.8)}px`; // You can adjust the factor "0.8" as required
        });
    }
}

window.addEventListener('resize', updateFontSize);
updateFontSize();

</script>


<script>
async function vote(pinId, action) {
    const res = await fetch('/vote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pin_id: pinId, action: action })
    });
    const data = await res.json();
    if (data.votes !== undefined) {
        document.querySelector(`#votes-${pinId}`).textContent = data.votes;
    }
}
</script>

<!--DELETE FUNCTION - PIN REMOVAL -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteAllPinsButton = document.getElementById('deleteAllPins');

    deleteAllPinsButton.addEventListener('click', function() {
        const confirmDelete = confirm("Are you sure you want to delete all pins?");
        
        if (confirmDelete) {
            // Remove from frontend
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            mapMobile.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    mapMobile.removeLayer(layer);
                }
            });

            // Remove from backend
            fetch('/delete_all_pins', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("All pins deleted successfully");
                } else {
                    console.log("Failed to delete pins");
                }
            })
            .catch(error => {
                console.log("An error occurred while deleting pins:", error);
            });
        }
    });
});

</script>
<script>
function fetchAndDisplayCounters() {
    // Fetch the counter data from the server
    fetch('/get_counters')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            let counterContainer = document.getElementById("counter-container");
            let counterContainerMobile = document.getElementById("counter-container-mobile");

            // Check if the elements exist
            if (!counterContainer || !counterContainerMobile) {
                console.error('Counter containers not found');
                return;
            }

            // Clear the existing counters
            counterContainer.innerHTML = "";
            counterContainerMobile.innerHTML = "";

            // Define the order of counter types
            const orderedCounterTypes = ['ff5c00', '9A031E', '133873', '358400', '431307', '070707'];

            // Loop through each counter type in the specified order and append a circle for it
            orderedCounterTypes.forEach(counterType => {
                let counterValue = data[counterType];

                let counterCircle = document.createElement("div");
                counterCircle.className = "counter-circle";
                counterCircle.style.backgroundColor = "#" + counterType;
                counterCircle.innerText = counterValue;

                let counterCircleMobile = counterCircle.cloneNode(true);
                counterCircleMobile.innerText = counterValue;

                counterContainer.appendChild(counterCircle);
                counterContainerMobile.appendChild(counterCircleMobile);
            });
        })
        .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
        });
}

// You can call this function on page load, or as often as needed to refresh the counter
fetchAndDisplayCounters();

</script>



<script>
    let filteredType = null;  // Keep track of the currently filtered pin type
    const pinOrder = ['ff5c00', '9A031E', '133873', '358400', '431307', '070707'];  // Specify the order of pin types

    function toggleFilter(pin_type) {
        if (filteredType === pin_type) {
            filteredType = null;
        } else {
            filteredType = pin_type;
        }
        // Update your map to show the filtered pins
        updateMap();
    }

    function fetchAndUpdateCounter() {
        fetch('/get_pin_counts')
        .then(response => response.json())
        .then(data => {
            let htmlStr = '';
            pinOrder.forEach(pin_type => {  // Loop through pin types in the specified order
                let count = data[pin_type];
                htmlStr += `<div class="counter-item"><span class="counter-circle" style="background-color: #${pin_type};" onclick="toggleFilter('${pin_type}')"></span>${count}</div>`;
            });
            htmlStr += `<div class="counter-item">Alles: ${data.total}</div>`;  // Add total count at the end
            document.getElementById('counter-container').innerHTML = htmlStr;
        });
    }

    function updateMap() {
        // Logic to update your map
        // Filter pins based on `filteredType` if it's not null
    }

    // Fetch and update the counter every 5 seconds
    setInterval(fetchAndUpdateCounter, 5000);

    // Fetch the counter when the page loads
    fetchAndUpdateCounter();
</script>

<!-- CSS PINS -->
<style>

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 1);
  z-index: 9999;
}

.container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 20px;
  background-color: white;
  border-radius: 50px;
}

.custom-popup .leaflet-popup-content {
    font-size: 40px; /* Adjust size as needed */
}

.countercontainer {
    background-color: white;
    border-radius: 50px;
    padding: 11px;
    color: black;
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, 0);
    z-index: 1000;  /* To ensure it's on top of other elements */
    text-align: center;  /* Center the content */
    display: flex;  /* Changed to flex */
    flex-wrap: nowrap;  /* Prevent wrapping onto new lines */
    justify-content: center;  /* Center items horizontally */
    min-width: 100px;  /* Optional: set a minimum width */
  display: flex;
    flex-wrap: nowrap;
    justify-content: center;
    overflow-x: auto;  /* Allow horizontal scrolling */
    white-space: nowrap;  /* Prevent wrapping onto new lines */
}

.togglebuttoncontainer {
    background-color: white;
    border-radius: 50px;
    padding: 5px;
    color: black;
    position: absolute;
    top: 60px;  /* Adjusted top value */
    left: 50%;
    transform: translate(-50%, 0);
    z-index: 1020;  /* To ensure it's on top of other elements */
    text-align: center;  /* Center the content */
    display: inline-block;  /* Allow the container to resize based on content */
    min-width: 100px;  /* Optional: set a minimum width */
}
.togglebuttoncontainer img {
    margin: 0;
    padding: 0;
}

.togglebuttoncontainer img {
    vertical-align: middle;
}

    /* Remove button appearance */
.toggle-button {
    border: none;
    background: none;
    padding: 0;
    margin: 0;
}

/* Style for icons */
.icon {
    width: 24px; /* or whatever size you want */
    height: auto;
}



.countercontainer:hover .tooltip {
    display: block;
    opacity: 0;
    animation: fadeIn 0.5s forwards;
}

@keyframes fadeIn {
    to {
        opacity: 1;
    }
}

.counter-item {
    display: inline-block;
    margin-right: 20px;
    font-size: 15px;  /* Make the font bigger */
    font-weight: bold;  /* Make the font bolder */
}

.counter-item:last-child {
    margin-right: 0;  /* Remove margin-right for the last counter-item */
	    margin-left: 0;  /* Remove margin-right for the last counter-item */

}

.counter-circle {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 5px;
    vertical-align: middle;
}

.countercontainer, .togglecontainer,
.countercontainer, .togglecontainer {
    position: absolute;
    top: 10px;
}
</style>

<style>

   .leaflet-top.leaflet-center {
        text-align: center;
        margin-left: auto;
        margin-right: auto;
        left: 50%;
        transform: translateX(-50%);
    }

.pin-label {
    background: none;
    border: none;
    font-size: 14px;
    font-weight: bold;
    color: red;
}

.delete-button {
    background-color: black;
    color: white;
    padding: 10px;
    cursor: pointer;
    border: none;
	margin-right: 5px;
	border-radius: 10px;
}

.star-button {
    background-color: black;
    color: white;
    padding: 8px;
    cursor: pointer;
    border: none;
	margin-right: 5px;
	border-radius: 10px;
}


.remove-star-button {
    background-color: black;
    color: white;
    padding: 8px;
    cursor: pointer;
    border: none;
	margin-right: 5px;
	border-radius: 10px;
}


#pin-menu-desktop {
    width: 100%;
    box-sizing: border-box; /* Ensure padding and border are included in the width */
}


.options {
    display: none;
    position: absolute;
    z-index: 1;
    top: 100%;
    left: 0;
    width: 100%;
}

.dropdown:hover .options {
    display: block;
}



.pin-menu h3 {
    color: white;
}




/* Hide mobile version by default */
.current-mobile {
    display: none;
}

/* On larger screens, only show the desktop version */
@media screen and (min-width: 901px) {

    .current-mobile {
        display: none;
    }
	   #dropdown-options {
        display: none !important; /* Using !important to ensure this rule takes precedence over inline styles or other conflicting styles */
    }
}

/* On smaller screens (or equal to 900px), only show the mobile version */
@media screen and (max-width: 900px) {

    .current-mobile {
        display: block;
    }
}

.options {
    display: block; /* This shows the dropdown on mobile devices by default */
}

@media (max-width: 900px) {
    .countercontainer,
    .togglebuttoncontainer {
        border-radius: 25px;  /* Reduced border radius */
        padding: -10px;  /* Reduced padding */
        min-width: 50px;  /* Optional: reduced minimum width */
    }

    .togglebuttoncontainer img {
        width: 20px;  /* Reduced icon size */
        height: 20px;  /* Reduced icon size */
    }
}

/* Hide mappy-container by default */
#mappy-container {
    display: none;
}

/* Show mappy-container only on smaller screens */
@media (max-width: 900px) {
    #mappy-container {
        display: block;
        margin: 3px;
        width: calc(100% - 6px); /* Minus margin from both sides */
    }

    #mapMobile {
        height: 400px;
        width: 100%;
		border-radius: 30px;
position: relative;
    }
	
	 .hide-on-mobile {
        display: none !important;
    }

}

}
}


/* Hide mobile dropdown by default */
#pin-menu-mobile {
    display: none;
}

/* Show mobile dropdown and hide desktop menu on smaller screens */
@media (max-width: 900px) {
    #pin-menu-desktop {
        display: none;
    }
    #pin-menu-mobile {
        display: block;
    }
}

/* Remove conflicting styles, if any */
.leaflet-control-layers-toggle {
    background-image: none;
    font-size: 20px;
    line-height: 24px;
    font-weight: bold;
    text-align: center;
}


.leaflet-control-container {
border-radius: 50px:
}

/* Custom Layer Control styles */
.leaflet-control-layers-toggle {
    background-image: url('static/mapicon.png');  /* Check if this path is correct */
    background-color: transparent;
    background-repeat: no-repeat;
    background-position: center;
	border-radius: 50px;
    width: 36px;
    height: 36px;
}


.leaflet-popup .leaflet-popup-content-wrapper .leaflet-popup-content {
    font-size: 20px !important;  /* Adjust size as desired */
}

    h2 {
        margin-top: 0px;    /* Adjust as needed */
        margin-bottom: 0px; /* Adjust as needed */
    }
	
	
    .info-title {
        font-weight: bold;
        font-size: 25px;
        margin: 10px;
    }

 .info-subtitle {
        font-weight: bold;
        font-size: 24px;
        margin: 10px;
    }

    .info-text {
        font-size: 20px; /* Adjust the font size as needed */
    }


#current-selection {
    background-color: #ddd;
    padding: 10px;
    margin-bottom: 0px;
	margin-top: -5px;

}

.pin-style {
    border: 3px solid transparent; /* Default transparent border */
    box-sizing: content-box; /* So that the border doesn't affect the pin's size */
    background: radial-gradient(circle, transparent 30%, transparent 100%);
    border-radius: 40%; 
    width: 24px; 
    height: 24px;
}


.satellite-view .pin-ff5c00 {
    background-image: radial-gradient(circle, #ff5c00 50%, rgba(255, 177, 0, 0.7) 50%);
    border: 2px solid rgba(255, 255, 255, 0.9);
}

.satellite-view .pin-9A031E {
    background-image: radial-gradient(circle, #9A031E 50%, rgba(154, 3, 30, 0.7) 50%);
    border: 2px solid rgba(255, 255, 255, 0.9);
}

.satellite-view .pin-133873 {
    background-image: radial-gradient(circle, #133873 50%, rgba(19, 56, 115, 0.7) 50%);
    border: 2px solid rgba(255, 255, 255, 0.9);
}

.satellite-view .pin-358400 {
    background-image: radial-gradient(circle, #358400 50%, rgba(53, 134, 0, 0.7) 50%);
    border: 2px solid rgba(255, 255, 255, 0.9);
}

.satellite-view .pin-431307 {
    background-image: radial-gradient(circle, #431307 50%, rgba(67, 19, 7, 0.7) 50%);
    border: 2px solid rgba(255, 255, 255, 0.9);
}

.satellite-view .pin-070707 {
    background-image: radial-gradient(circle, #070707 50%, rgba(7, 7, 7, 0.7) 50%);
    border: 2px solid rgba(255, 255, 255, 0.9);
}


.pin-ff5c00 {
    color: #ff5c00;
    background-image: radial-gradient(circle, #ff5c00 30%, rgba(255, 177, 0, 0.2) 40%);
}

.pin-9A031E {
    color: #9A031E;
    background-image: radial-gradient(circle, #9A031E 30%, rgba(154, 3, 30, 0.2) 40%);
}

.pin-133873 {
    color: #133873;
    background-image: radial-gradient(circle, #133873 30%, rgba(19, 56, 115, 0.2) 40%);
}

.pin-358400 {
    color: #358400;
    background-image: radial-gradient(circle, #358400 30%, rgba(53, 134, 0, 0.2) 40%);
}

.pin-431307 {
    color: #431307;
    background-image: radial-gradient(circle, #431307 30%, rgba(67, 19, 7, 0.2) 40%);
}

.pin-070707 {
    color: #070707;
    background-image: radial-gradient(circle, #070707 30%, rgba(7, 7, 7, 0.2) 40%);
}




.info-field {
    background-color: rgba(0, 0, 0, 0.7);
    border-radius: 10px;
    padding: 20px;
    color: white;
    text-align: center; /* Center the text */
}


#current-selection {
    font-weight: bold;
    border: 5px solid white;
    padding: 10px 0;
    margin: 2px 0;
    cursor: pointer;
    font-size: 20px;
    text-decoration: none;
    display: block;
    width: 100%;
    transition: background-color 0.2s ease-in-out;
    border-radius: 30px;
    box-sizing: border-box;
    text-align: center;
    background-color: white;
    color: black;
}

.dropdown-menu2 {

    font-weight: bold;
    border: 5px solid white;
    margin: -1px 0;
	padding: 0px 10px;
    line-height: 0;  /* Adjust line-height */
    cursor: pointer;
    font-size: 24px;
    text-decoration: none;
    display: block;
    width: 100%;
    box-sizing: border-box; /* Ensure padding and border are included in the width */
    padding: 0px 10px; /* Adjust padding as per design requirement */
    transition: background-color 0.2s ease-in-out;
    border-radius: 30px;
    box-sizing: border-box;
    text-align: center;
}

.button-menu {
    font-weight: bold;
    border: 5px solid white;
    padding: 7px 0;
    margin: 2px 0;
    cursor: pointer;
    font-size: 24px;
    text-decoration: none;
    display: block;
    width: 100%;
    transition: background-color 0.2s ease-in-out;
    border-radius: 30px;
    box-sizing: border-box;
    text-align: center;
    color: white;
}


    font-weight: bold;
    border: 4px solid white;
    margin: -1px 0;
	padding: 0px 10px;
    line-height: 0;  /* Adjust line-height */
    cursor: pointer;
    font-size: 24px;
    text-decoration: none;
    display: block;
    width: 100%;
    box-sizing: border-box; /* Ensure padding and border are included in the width */
    padding: 0px 10px; /* Adjust padding as per design requirement */
    transition: background-color 0.2s ease-in-out;
    border-radius: 30px;
    box-sizing: border-box;
    text-align: center;
}
.centered-text-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    width: 100%; /* Ensure it takes up the full width of its parent. */
}

.centered-text-container h2 {
    font-size: 4vw; /* This will make the font size 4% of the viewport width. Adjust this as necessary. */
}

@media screen and (max-width: 900px) {
    .centered-text-container h2 {
        font-size: 5vw; /* Increase font size on smaller screens. Adjust as necessary. */
    }
}

.centered-text-container h2 {
    margin: 0; /* Removes default margins. Adjust if you need some spacing between them. */
    padding: 0; /* Removes any default padding. */
}



#sidebar h2 {
    margin: 0px 0;
}


.pin-ff5c00 { color: #ff5c00; }
.pin-9A031E { color: #9A031E; }
.pin-133873 { color: #133873; }
.pin-358400 { color: #358400; }
.pin-431307 { color: #431307; }
.pin-070707 { color: #070707; }

.pin-menu {
    font-weight: bold;
    border: 4px solid white;
    margin: -1px 0;
	padding: 0px 10px;
    line-height: 0;  /* Adjust line-height */
    cursor: pointer;
    font-size: 24px;
    text-decoration: none;
    display: block;
    width: 100%;
    box-sizing: border-box; /* Ensure padding and border are included in the width */
    padding: 0px 10px; /* Adjust padding as per design requirement */
    transition: background-color 0.2s ease-in-out;
    border-radius: 30px;
    box-sizing: border-box;
    text-align: center;
}


// Add this CSS to your stylesheet
.star-icon {
    pointer-events: none;
}

.pin-menu:hover {
    background-color: #e0e0e0;
}




#sidebar img {
    max-width: 100%;
    height: auto;
    border: 5px solid white;
    display: block;
    margin-bottom: 20px;
    border-radius: 10px;
}

#sidebar {
    display: flex;
    flex-direction: column;
    justify-content: center; /* Vertically center the contents */
    align-items: center;     /* Horizontally center the contents */
    flex-basis: 20%;
    padding: 20px;
    background-color: ##405F5E;  /* Updated this line */
    margin-top: 1.5%;
	    margin-bottom: 1.5%;
    margin-left: 2.5%;
    margin-right: 2.5%;

    border-radius: 10px;
	
}
.current {
    font-weight: bold;
    border: 5px solid white;
    padding: 50px 0;
    margin: 2px 0;
    cursor: pointer;
    font-size: 15px;
    text-decoration: none;
    display: block;
    width: 100%;
    transition: background-color 0.2s ease-in-out;
    border-radius: 10px;
    box-sizing: border-box;
    text-align: center;
       background-color: white;
    color: black;
}

.current:hover {
    background-color: #e0e0e0;
}


#feedbackText {
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 10px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    font-size: 20px;
    text-decoration: none;
    display: inline-block;
    border-radius: 10px;
    transition: background-color 0.2s ease-in-out;
    resize: none; /* Disables resizing of the textarea */
}

#postFeedback {
    background-color: #5DA271;
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s ease-in-out;
}

#postFeedback:hover {
    background-color: #4D8A5D;
}

#cancelFeedback {
    background-color: #C84630;
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s ease-in-out;
}

#cancelFeedback:hover {
    background-color: #AD3A26;
}



/* Make sure the HTML and body take up the full viewport height */
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}
body {
    font-family: 'Roboto', sans-serif;
}







/* MOBILE CSS */


h2 {
    text-align: center; /* Center text horizontally */

    /* If you want to center the h2 vertically within its container, you can use these properties, but they might not be necessary for all use cases: */
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}
.leaflet-container .leaflet-tile {
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
}

@media screen and (min-width: 901px) {
    #dropdown-button {
        display: none;
		margin-top:10px;

    }
	
	
}

@media screen and (max-width: 900px) {
    .pin-menu {
	 font-size: 2vw; /* adjust as needed */
        max-height: calc(2em + 14px); /* 2 times the font size + 2 times the padding */
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        box-sizing: border-box;
		 display: flex;
        justify-content: center;
        align-items: center;
        height: auto;  // This ensures the container grows with its content
        padding: 7px;
    }
}

@media screen and (min-width: 901px) {
    #dropdown-options {
        display: none !important; /* Important can ensure that this rule takes precedence over inline styles */
    }
}

@media screen and (max-width: 900px) {


.dropdown-container {
    width: 100%; /* Ensure the container takes full width of its parent */
    padding: 0;  /* Remove padding so children can stretch fully */
    box-sizing: border-box; /* This will include any padding and borders in the element's total width */
	   position: relative;
}
    ...
.clearfix::after {
    content: "";
    display: table;
    clear: both;
}

/* Dropdown button */
   #dropdown-button {
           font-weight: bold;
    border: 5px solid white;
    padding: 7px 0;
    margin: 2px 0;
    cursor: pointer;
    font-size: 24px;
    text-decoration: none;
    display: block;
    width: 100%;
    transition: background-color 0.2s ease-in-out;
    border-radius: 30px;
    box-sizing: border-box;
    text-align: center;
    color: white;
	    z-index: 2;  /* Ensure it's above the dropdown-options in stacking order */

}

	
/* Dropdown icon (you can use an actual icon; this is just for demonstration) */
#dropdown-button:after {
    content: "▼"; /* A downward arrow; you can replace this with an SVG or another icon */
    width: 100%; /* Stretching across the entire boundaries */
        margin-left: 0; /* Removing left margin */
        margin-right: 0; /* Removing right margin */
    }


/* Options that appear on dropdown click */
#dropdown-options {
    border-top: none; /* Remove top border to blend with dropdown button */
    border-radius: 0 0 10px 10px; /* Only round bottom corners */
	max-width: 100%;
    top: 100%;  /* Positioning it right below the dropdown-button */
		  width: 100%;
        left: 0;
        right: 0;
        margin-left: auto;
        margin-right: auto;
        box-sizing: border-box;
	    z-index: 1;  /* Ensure it's above the dropdown-options in stacking order */

}



    h2 + h2 {
        margin-top: -10px; /* Adjust this value to control the gap. Negative values bring the lines closer together. */
    }

    .main-container {
        display: flex;
        width: 100%;  /* Ensure this container takes the full width */
        height: 100%;
        flex-direction: column;
        align-items: center; 
        justify-content: flex-start;
        padding: 0;  /* Ensure no padding */
        margin: 0;  /* Ensure no margin */
    }
 #sidebar {
        width: 90%; 
        max-width: 90%;  /* Ensure it doesn't go beyond this width */
        padding: 10px;
        box-sizing: border-box; 
        height: auto; 
        margin: 0 auto;  /* Centering shorthand */
    }

    #mapContainer {
        width: 90%;  /* 5% margin on each side */
        height: 300px;  /* Fixed height for mobile, adjust if necessary */
        margin: 5% auto;  /* Center the map container horizontally */
    }

    #map {
        display: none;

    }
}



@media screen and (max-width: 900px) {
   
   div[style="display: flex; height: 100vh"] {
        flex-direction: column;
        align-items: center;     
        justify-content: flex-start;
    }
    
    /* Logo at the top */
    img[src="static/logo_long.png"] {
        display: block;
        max-width: 90%;
		        width: 90%;

		        height: auto;
                margin-left: auto;
        margin-right: auto;
		
    }
    
   
    /* Map below headings */



    
    /* Container adjustment */
    div[style="display: flex; height: 100vh"] {
        flex-direction: column;
    }




}






.cursor-pin-ff5c00 { 
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="%23ff5c00" /></svg>'), auto; 
}
.cursor-pin-9A031E { 
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="%239A031E" /></svg>'), auto; 
}
.cursor-pin-133873 { 
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="%23133873" /></svg>'), auto; 
}
.cursor-pin-358400 { 
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="%23358400" /></svg>'), auto; 
}
.cursor-pin-431307 { 
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="%23431307" /></svg>'), auto; 
}
.cursor-pin-070707 { 
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="%23070707" /></svg>'), auto; 
}

</style>

<script>
function applyColor() {
    let selectedOption = $('#pin-dropdown option:selected');
    let color = selectedOption.data('color');
    // Handle your color or functionality here
    console.log(color);  // For testing purposes
}
</script>

<!-- HAMBURGER MENU CLOSING LOGIC -->
<script>

</script>


<!-- PIN CARRYING UPON CLICK -->
<script>
document.querySelectorAll(".pin-menu").forEach(menu => {
    menu.addEventListener("click", function() {
        selectedColor = this.getAttribute("data-color");
        document.getElementById("selected-pin-type").innerText = pins[selectedColor];
        document.getElementById("selected-pin-type").style.color = "#" + selectedColor;

        // Update cursor style
        map.getContainer().classList.remove(...Array.from(map.getContainer().classList).filter(c => c.startsWith('cursor-pin-')));
        map.getContainer().classList.add(`cursor-pin-${selectedColor}`);
    });
});

map.on('click', function(e) {
    // Rest of your existing logic

    // Remove custom cursor after pin is placed
    map.getContainer().classList.remove(...Array.from(map.getContainer().classList).filter(c => c.startsWith('cursor-pin-')));
});
</script>


<!-- PIN RETRIEVAL -->

<script>
document.addEventListener("DOMContentLoaded", function() {
    fetch('/get_pins')  // Assuming '/get_pins' is the endpoint that returns all pins
    .then(response => response.json())
    .then(data => {
        if(data && data.pins) {
            loadPins(data.pins);
        }
    });
});

function loadPins(pins) {
    pins.forEach(pin => {
        const markerHtml = `
            <div style="position: relative; text-align: center; width: 24px;">
                <div style="position: absolute; width: 100%; top: -15px;">M${pin.molen_id}</div>
                <div class="pin-style pin-${pin.pin_type}" style="width: 24px; height: 24px;"></div>
            </div>
        `;

        const markerIcon = L.divIcon({
            className: '',
            iconSize: [24, 24],
            html: markerHtml
        });

        const deleteButtonHtml = `<button class="delete-button" style="margin-top: 5px;" data-pin-id="${pin.id}" data-molen-id="${pin.molen_id}">Löschen</button>`;
        const starButtonHtml = `<button class="star-button" data-molen-id="${pin.molen_id}">⭐ markieren</button>`;
		const removeStarButtonHtml = pin.highlight_id ? `<button class="remove-star-button" onclick="removeStar('${pin.molen_id}')">⭐ entfernen</button>` : '';
        const popupContent = starButtonHtml + deleteButtonHtml + removeStarButtonHtml + pin.description;

        const markerMap = L.marker([pin.lat, pin.lon], { icon: markerIcon }).bindPopup(popupContent);
        const markerMapMobile = L.marker([pin.lat, pin.lon], { icon: markerIcon }).bindPopup(popupContent);

        markerMap.addTo(map);
        markerMapMobile.addTo(mapMobile);

        if (pin.highlight_id) {
            console.log(`highlight_id is set for pin: ${pin.molen_id}`);  // Debug line
            const starIcon = L.icon({
                iconUrl: '/static/star_icon.png',
                iconSize: [30, 30],
                iconAnchor: [10, 10],
				className: 'star-icon'  // Add a class name to the star icon
            });
            const starMarker = L.marker([pin.lat, pin.lon], { icon: starIcon }).addTo(map);
            const starMarkerMobile = L.marker([pin.lat, pin.lon], { icon: starIcon }).addTo(mapMobile);
        } else {
            console.log(`highlight_id is NOT set for pin: ${pin.molen_id}`);  // Debug line
        }


        markerMap.on('popupopen', function(event) {
            handleStarButtonClick(event);
            handleDeleteButtonClick(event);
        });
        markerMapMobile.on('popupopen', function(event) {
            handleStarButtonClick(event);
            handleDeleteButtonClick(event);
        });
    });

	
	
	
	
}

function handleStarButtonClick(event) {
    const starButton = event.popup._contentNode.querySelector('.star-button');
    if (starButton) {
        starButton.addEventListener('click', function() {
            const molenId = this.getAttribute('data-molen-id');
            highlightPin(molenId);
        });
    }
}

function highlightPin(molenId) {
    fetch(`/highlight_pin/${molenId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                refreshMap();
            }
        });
}

function refreshMap() {
    // Assumes map and mapMobile are global variables representing your map instances
    map.eachLayer(layer => map.removeLayer(layer));
    mapMobile.eachLayer(layer => mapMobile.removeLayer(layer));
    fetch('/get_pins')
        .then(response => response.json())
        .then(data => {
            if(data && data.pins) {
                loadPins(data.pins);
            }
        });
}

function handleDeleteButtonClick(event) {
    const deleteButton = event.popup._contentNode.querySelector('.delete-button');
    if (deleteButton) {
        deleteButton.addEventListener('click', function() {
            const molenId = this.getAttribute('data-molen-id');
            deletePinByMolenId(molenId);
        });
    }
}

function deletePinByMolenId(molenId) {
    fetch(`/delete_pin_by_molen_id/${molenId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                refreshMap();
            }
        });
}


function removeStar(molenId) {
    fetch(`/remove_star/${molenId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                refreshMap();
            }
        });
}




function applyColor() {
    let selectedOption = document.querySelector('#pin-dropdown option:checked');
    let color = selectedOption.getAttribute('data-color');
    console.log(color);  // For testing purposes
}

document.querySelectorAll(".pin-menu").forEach(menu => {
    menu.addEventListener("click", function() {
        let selectedColor = this.getAttribute("data-color");
        document.getElementById("selected-pin-type").innerText = pins[selectedColor];
        document.getElementById("selected-pin-type").style.color = "#" + selectedColor;

        // Update cursor style for both maps
        map.getContainer().classList.remove(...Array.from(map.getContainer().classList).filter(c => c.startsWith('cursor-pin-')));
        mapMobile.getContainer().classList.remove(...Array.from(mapMobile.getContainer().classList).filter(c => c.startsWith('cursor-pin-')));
        
        map.getContainer().classList.add(`cursor-pin-${selectedColor}`);
        mapMobile.getContainer().classList.add(`cursor-pin-${selectedColor}`);
    });
});

// Handle pin placement for both maps
function handleMapClick(mapInstance) {
    mapInstance.on('click', function(e) {
        const markerIcon = L.divIcon({
            className: `pin-style pin-${selectedColor}`,  // Assuming 'selectedColor' is the selected pin color
            iconSize: [24, 24]
        });
        
        const marker = L.marker([e.latlng.lat, e.latlng.lon], { icon: markerIcon }).bindPopup('Description Here'); // Replace 'Description Here' as needed
        marker.addTo(mapInstance);

        // Optionally, add logic to save the pin to your server
    });
    
    // Remove custom cursor after pin is placed
    mapInstance.getContainer().classList.remove(...Array.from(mapInstance.getContainer().classList).filter(c => c.startsWith('cursor-pin-')));
}

handleMapClick(map);
handleMapClick(mapMobile);

document.getElementById('aboutBtn').addEventListener('click', function() {
    document.getElementById('infoModal').style.display = 'flex';
});

document.getElementById('infoModal').addEventListener('click', function(event) {
    if (event.target === this) {
        this.style.display = 'none';
    }
});
</script>

<script>
document.getElementById('aboutBtn').addEventListener('click', function() {
    document.getElementById('infoModal').style.display = 'flex';
});

// Close the modal when clicking outside the info field
document.getElementById('infoModal').addEventListener('click', function(event) {
    if (event.target === this) {
        this.style.display = 'none';
    }
});
</script>

<script>
function deletePin(pinId) {
    fetch(`/delete_pin/${pinId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                refreshMap();
            }
        });
}

function refreshMap() {
    map.eachLayer(layer => {
        if (layer instanceof L.Marker) {
            map.removeLayer(layer);
        }
    });
    mapMobile.eachLayer(layer => {
        if (layer instanceof L.Marker) {
            mapMobile.removeLayer(layer);
        }
    });
    fetch('/get_pins')
        .then(response => response.json())
        .then(data => {
            if (data && data.pins) {
                loadPins(data.pins);
            }
        });
}

</script>


{% endblock %}

</html>
